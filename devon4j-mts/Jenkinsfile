@Library('pdehnel-sharedlib@feature/devon4j')

//Sharedlibrary configuration
import com.capgemini.productionline.configuration.*
Jenkins jenkinsConfiguration = new Jenkins();
GitLab gitlabConfiguration = new GitLab(this, params.GITLAB_USER_PRIVATE_TOKEN);

pipeline {
    agent any
    
    //Jenkins Job Parameters
    parameters { 
        string(name: 'GITLAB_USER_PRIVATE_TOKEN', defaultValue: 'BSXJct1gp1xozXCmfsc_', description: 'NEEDS TO BE SET!. Private Token of a Production Line Gitlab User that can be used to create repositories.') 
        string(name: 'GITLAB_CREATE_GROUP_NAME', defaultValue: 'devon', description: 'Private Token of a Production Line Gitlab User that can be used to create repositories.') 
        string(name: 'GITLAB_CREATE_PROJECT_NAME', defaultValue: 'MyThaiStar', description: 'Private Token of a Production Line Gitlab User that can be used to create repositories.') 
        string(name: 'GITLAB_CREATE_BRANCH', defaultValue: 'master', description: 'Private Token of a Production Line Gitlab User that can be used to create repositories.') 
        string(name: 'GITLAB_CREATE_PROJECT_DESCRIPTION', defaultValue: 'MyThaiStar Sample Devon4J application', description: 'Private Token of a Production Line Gitlab User that can be used to create repositories.') 

    }
    
    stages {
        stage('PL preparation') {
            steps{
                script{
                    //Create a group for devon
                    // public createGroup(String groupname, String grouppath, String groupdesc, String grouptype) {
                    gitlabConfiguration.createGroup(params.GITLAB_CREATE_GROUP_NAME, params.GITLAB_CREATE_GROUP_NAME, params.GITLAB_CREATE_PROJECT_DESCRIPTION, "public")

                    //Create a new public repository for MyThaiStar inside the Production Line based on the official repository
                    gitlabConfiguration.createProject(
                        params.GITLAB_CREATE_GROUP_NAME, 
                        params.GITLAB_CREATE_PROJECT_NAME, 
                        params.GITLAB_CREATE_PROJECT_NAME, 
                        params.GITLAB_CREATE_PROJECT_DESCRIPTION, 
                        params.GITLAB_CREATE_BRANCH, 
                        "https://github.com/devonfw/my-thai-star.git",
                        "public"
                        )
                }
            }
        }

        stage('Generate build and deploy jobs in Jenkins'){
            steps{
                //Build job
                jobDsl scriptText: '''pipelineJob("MyThaiStar_FRONTEND_BUILD") {
                                        definition {
                                            cpsScm {
                                            scm {
                                                git(ProductionLineGlobals.GITLAB_BASE_URL+"/"+params.GITLAB_CREATE_GROUP_NAME+"/"+params.GITLAB_CREATE_PROJECT_NAME)
                                                scriptPath(\'jenkins/angular/cicd/Jenkinsfile\')
                                            }
                                            }
                                        }
                                    }'''

                //Build job
                jobDsl scriptText: '''pipelineJob("MyThaiStar_SERVER_BUILD") {
                                        definition {
                                            cpsScm {
                                            scm {
                                                git(ProductionLineGlobals.GITLAB_BASE_URL+"/"+params.GITLAB_CREATE_GROUP_NAME+"/"+params.GITLAB_CREATE_PROJECT_NAME)
                                                scriptPath(\'jenkins/java/cicd/Jenkinsfile\')
                                            }
                                            }
                                        }
                                    }'''

                //Deploy job

            }
        }
    }
}